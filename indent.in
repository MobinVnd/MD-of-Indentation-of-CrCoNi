clear
units           metal
atom_style      atomic
dimension       3

# -------------------------
# User controls
# -------------------------
variable pot            string NiCoCr.lammps.eam

# Choose target box size:
variable a              equal 3.56
variable size           equal 141           # 50 nm  = 500 Å  -> size ~ 141 lattice units for a=3.56 Å

# Composition targets (Cr, Co, Ni) ~ 1/3 each
variable xCr            equal 0.3333333333
variable xCo            equal 0.3333333333
variable xNi            equal 0.3333333334

# Thermo schedule
variable T_high         equal 800
variable T_low          equal 300

# Time integration
variable dt             equal 0.001          # ps
timestep                ${dt}

# Run lengths
variable steps_eq_high  equal 200000         # NPT+SGCMC at 800K (example)
variable steps_cool     equal 6000000        # cool 800->300 over 6 ns (paper-like)
variable steps_eq_low   equal 200000         # NPT+SGCMC at 300K (example)

# Semi-Grand Canonical Monte Carlo for SRO
variable nsteps_mc      equal 20
variable swap_fraction  equal 0.25
variable kappa          equal 1.0e3
variable dmu1           equal 0.021
variable dmu2           equal -0.31
variable seed_vel       equal 2442425
variable seed_mc        equal 4324235

# Indenter radius (Å):
variable R              equal 20.0           # 50 Å

# Repulsive stiffness for fix indent:
variable K              equal 284.1          # k = 1000/3.52 ~ 284.1

# Indentation displacement rate (Å/ps)
variable vload          equal 0.02           # 0.02 Å/ps = 20 m/s (1 Å/ps = 100 m/s)

# Total indentation depth (Å)
variable depth          equal 100.0

# Hold time (ps) and unload rate
variable thold_ps       equal 1000.0
variable vunload        equal ${vload}

# Vacuum thickness above surface (Å)
variable vacuum         equal 200.0

# Fixed bottom layer thickness (Å)
variable zfix           equal 20.0

# -------------------------
# Stage A: Build bulk + SRO
# -------------------------
boundary        p p p
lattice         fcc ${a}
region          box block 0 ${size} 0 ${size} 0 ${size} units lattice
create_box      3 box
create_atoms    1 box

# EAM/alloy Potential
pair_style      eam/alloy
pair_coeff      * * ${pot} Ni Co Cr

# Masses (from your in.vc_sgc)
mass 1 58.69    # Ni
mass 2 58.93    # Co
mass 3 51.996   # Cr

# Start all as type 1 (Ni), then convert fractions to Co and Cr
set type 1 type/fraction 2 ${xCo} ${seed_mc}
set type 1 type/fraction 3 ${xCr} ${seed_vel}

# Neighbor
neighbor        1.0 bin
neigh_modify    delay 0 every 1 check yes

# Initialize velocities
velocity        all create ${T_high} ${seed_vel} dist gaussian

# NPT (bulk) + VC-SGC
fix             npt all npt temp ${T_high} ${T_high} 1.0 aniso 0.0 0.0 1.0
fix             mc  all sgcmc ${nsteps_mc} ${swap_fraction} ${T_high} ${dmu1} ${dmu2} &
                randseed ${seed_mc} variance ${kappa} ${xNi} ${xCo}

thermo          1000
thermo_style    custom step temp press pe lx ly lz f_mc[1] f_mc[2] f_mc[3] f_mc[4]
thermo_modify   flush yes

shell           mkdir sro_stage
dump            dA all custom 50000 sro_stage/sro.*.dump id type x y z

# Equilibrate at high T
run             ${steps_eq_high}

# Cool 800 -> 300 K over while continuing MC+NPT
unfix           npt
fix             npt all npt temp ${T_high} ${T_low} 1.0 aniso 0.0 0.0 1.0
run             ${steps_cool}

# Equilibrate at low T with MC
unfix           npt
fix             npt all npt temp ${T_low} ${T_low} 1.0 aniso 0.0 0.0 1.0
run             ${steps_eq_low}

# Save SRO structure for indentation stage
write_data      sro_ready.data

# Stop SRO fixes
unfix           npt
unfix           mc
undump          dA

# -------------------------
# Stage B: Free surface + indentation
# -------------------------
clear
units           metal
atom_style      atomic
dimension       3

# Free surface in z: periodic x,y; fixed z
boundary        p p f

read_data       sro_ready.data

pair_style      eam/alloy
pair_coeff      * * ${pot} Ni Co Cr

mass 1 58.69    # Ni
mass 2 58.93    # Co
mass 3 51.996   # Cr

neighbor        1.0 bin
neigh_modify    delay 0 every 1 check yes

# Add vacuum above top surface (+z)
variable zhi    equal zhi
variable znew   equal v_zhi + ${vacuum}                    # Current box is [zlo, zhi]; extend zhi by "vacuum"
change_box      all z final 0.0 ${znew} units box remap

# Define fixed bottom layer (0 <= z <= zfix)
region          bottom block INF INF INF INF 0.0 ${zfix} units box
group           lower region bottom
group           mobile subtract all lower

# Fix bottom, integrate mobile
fix             freeze lower setforce 0.0 0.0 0.0
velocity        lower set 0.0 0.0 0.0

# Equilibrate at 300K with NVT on mobile only
compute         Tmob mobile temp
fix             nvt mobile nvt temp ${T_low} ${T_low} 1.0
fix_modify      nvt temp Tmob

reset_timestep  0
shell           mkdir indent_stage
dump            dB all custom 20000 indent_stage/indent.*.dump id type x y z
thermo          1000
thermo_style    custom step temp c_Tmob pe press lx ly lz
thermo_modify   flush yes

# Short relax
run             200000

# Indenter center: at box center in x, y, above surface
variable x0     equal 0.5*lx
variable y0     equal 0.5*ly

# Indenter motion: move down by "depth" at rate vload, hold, then unload
variable n_hold equal floor(${thold_ps}/${dt})           # Convert hold time (ps) to steps: thold_ps/dt

# Loading steps = depth / (vload*dt)
variable n_load equal ceil(${depth}/(${vload}*${dt}))
# Unload steps = same depth / (vunload*dt)
variable n_unld equal ceil(${depth}/(${vunload}*${dt}))

# z start: a bit above current top surface
variable ztop   equal bound(all,zmax)
variable zstart equal v_ztop + ${R} + 10.0

# During loading, z decreases linearly
variable zload  equal v_zstart - step*${vload}*${dt}
# During hold, freeze z at end-of-load position
variable zend   equal v_zstart - ${depth}

# Three runs and redefine the variable each time.

# --- Load
variable zpos   equal v_zload
fix             ind all indent ${K} sphere ${x0} ${y0} v_zpos ${R} units box

thermo_style    custom step temp c_Tmob pe press f_ind[1] f_ind[2] f_ind[3] v_zpos
run             ${n_load}

# --- Hold
unfix           ind
variable zpos   equal v_zend
fix             ind all indent ${K} sphere ${x0} ${y0} v_zpos ${R} units box

run             ${n_hold}

# --- Unload (move indenter back up)
unfix           ind
# reset step counter so motion is simple (optional)
reset_timestep  0
variable zup    equal v_zend + step*${vunload}*${dt}
variable zpos   equal v_zup
fix             ind all indent ${K} sphere ${x0} ${y0} v_zpos ${R} units box

run             ${n_unld}

# Cleanup
unfix           ind
unfix           nvt
unfix           freeze
undump          dB

write_data      final_after_indent.data
print "DONE: SRO+Indentation completed."
